<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Day Luge</title>
    <!-- Use Tailwind CSS for responsive and modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Courier+Prime:wght@400;700&display=swap');
        body {
            font-family: 'Courier Prime', monospace;
            background-color: #ffffff; /* Classic white background */
        }
        .link-column a {
            word-wrap: break-word; /* Prevents long links from breaking the layout */
        }
        .link-text {
            color: black;
            transition: color 0.3s;
        }
        /* Custom link colors */
        .color-red { color: #dc2626; }
        .color-blue { color: #2563eb; }
        .color-black { color: #000000; }
        .color-gray { color: #4b5563; }
        .color-green { color: #16a34a; }
        .color-purple { color: #7c3aed; }
        .link-text:hover {
            text-decoration: underline;
        }
        #thedayluge-title {
            cursor: pointer;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }
    </style>
</head>
<body class="bg-white flex flex-col items-center min-h-screen p-4" title="The Day Luge">

    <!-- Firebase SDKs for authentication and data storage -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Global variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const authToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth, userId;
        let allLinksData = []; // Store all links fetched from the database
        const LINKS_TO_DISPLAY = 100; // Number of recent links to show initially

        // Placeholder content to use when the database is empty
        const placeholderLinks = [
            { "title": "News from the 'Bud Light School of Corporate Strategy'", "url": "https://www.zerohedge.com/news/2025-08-22/cracker-barrel-crashes-after-going-woke", "color": "red" },
            { "title": "Markets Close on a High Note", "url": "#", "color": "blue" },
            { "title": "New Study on Climate Change", "url": "#", "color": "green" },
            { "title": "Local Sports Team Wins Big", "url": "#", "color": "black" },
            { "title": "Political Gridlock Continues", "url": "#", "color": "red" },
            { "title": "Tech Giant Unveils New Device", "url": "#", "color": "purple" },
            { "title": "Breaking News from the Middle East", "url": "#", "color": "red" },
            { "title": "World Leaders Discuss Trade", "url": "#", "color": "blue" },
            { "title": "Economic Forecast for Q4", "url": "#", "color": "black" },
            { "title": "Science Discoveries of the Week", "url": "#", "color": "green" },
            { "title": "Entertainment: New Movie Review", "url": "#", "color": "purple" },
            { "title": "Global Health Report Released", "url": "#", "color": "blue" },
            { "title": "A Look at the Housing Market", "url": "#", "color": "black" },
            { "title": "Foreign Policy in Focus", "url": "#", "color": "red" },
            { "title": "Lifestyle: New Fitness Trend", "url": "#", "color": "green" },
            { "title": "Crime Report: City-Wide Alert", "url": "#", "color": "red" },
            { "title": "Cultural Event Calendar", "url": "#", "color": "purple" },
            { "title": "The Latest in Space Exploration", "url": "#", "color": "blue" },
            { "title": "Analysis of the Stock Market", "url": "#", "color": "black" },
            { "title": "Updates on a Major Disaster", "url": "#", "color": "red" },
            { "title": "Art and Design: A New Exhibit", "url": "#", "color": "purple" },
            { "title": "International Business Deal", "url": "#", "color": "green" },
            { "title": "Political Campaign News", "url": "#", "color": "black" },
            { "title": "Sports: Player Contracts Updated", "url": "#", "color": "blue" },
            { "title": "Global Food Shortage Warning", "url": "#", "color": "red" },
            { "title": "New Research on AI", "url": "#", "color": "green" },
            { "title": "Commentary on Social Issues", "url": "#", "color": "black" },
            { "title": "Celebrity Scandal Breaks", "url": "#", "color": "purple" },
            { "title": "Breaking News: A Major Incident", "url": "#", "color": "red" },
            { "title": "Interview with the CEO", "url": "#", "color": "blue" },
            { "title": "The Future of Renewable Energy", "url": "#", "color": "green" },
            { "title": "Weekly Tech Report", "url": "#", "color": "black" },
            { "title": "Military News and Updates", "url": "#", "color": "red" },
            { "title": "Health: Breakthrough in Medicine", "url": "#", "color": "blue" },
            { "title": "World Politics: New Alliances", "url": "#", "color": "green" },
            { "title": "Finance: Expert Analysis", "url": "#", "color": "black" },
            { "title": "The Rise of New Media", "url": "#", "color": "purple" },
            { "title": "Crisis in a European Nation", "url": "#", "color": "red" },
            { "title": "Science News: New Species Found", "url": "#", "color": "blue" },
            { "title": "Local Government News", "url": "#", "color": "black" },
            { "title": "Latest on the War in Ukraine", "url": "#", "color": "red" },
            { "title": "Sports: Analysis of the Game", "url": "#", "color": "green" },
            { "title": "Entertainment: New Album Release", "url": "#", "color": "purple" },
            { "title": "Business: Mergers and Acquisitions", "url": "#", "color": "blue" },
            { "title": "Commentary on Political Affairs", "url": "#", "color": "black" },
            { "title": "Urgent Security Alert", "url": "#", "color": "red" },
            { "title": "Humanitarian Crisis Deepens", "url": "#", "color": "red" },
            { "title": "New Global Economic Data", "url": "#", "color": "blue" },
            { "title": "The Latest in Quantum Computing", "url": "#", "color": "green" },
            { "title": "The Future of Transportation", "url": "#", "color": "black" },
            { "title": "Military Drills Begin", "url": "#", "color": "red" },
            { "title": "Health: Study on a New Virus", "url": "#", "color": "blue" },
            { "title": "World Politics: UN Meeting Summary", "url": "#", "color": "green" },
            { "title": "Finance: Interest Rate Hikes", "url": "#", "color": "black" },
            { "title": "Entertainment: Box Office Report", "url": "#", "color": "purple" },
            { "title": "Crisis in a South American Nation", "url": "#", "color": "red" },
            { "title": "Science News: Mars Rover Update", "url": "#", "color": "blue" },
            { "title": "Local Community News", "url": "#", "color": "black" },
            { "title": "Latest on Cyber Security", "url": "#", "color": "red" },
            { "title": "Sports: Team Standings Update", "url": "#", "color": "green" },
            { "title": "Entertainment: TV Show Finale", "url": "#", "color": "purple" },
            { "title": "Business: Startup Success Story", "url": "#", "color": "blue" },
            { "title": "Commentary on Current Events", "url": "#", "color": "black" },
            { "title": "Urgent Weather Alert", "url": "#", "color": "red" },
            { "title": "Refugee Crisis Worsens", "url": "#", "color": "red" },
            { "title": "Global Economic Summit", "url": "#", "color": "blue" },
            { "title": "The Latest in Biotechnology", "url": "#", "color": "green" },
            { "title": "The Future of Work", "url": "#", "color": "black" },
            { "title": "Political Scandal in the Capital", "url": "#", "color": "red" },
            { "title": "Health: Report on Mental Wellness", "url": "#", "color": "blue" },
            { "title": "World Politics: Sanctions Imposed", "url": "#", "color": "green" },
            { "title": "Finance: Crypto Market Crash", "url": "#", "color": "black" },
            { "title": "Entertainment: Gaming News", "url": "#", "color": "purple" },
            { "title": "Crisis in an African Nation", "url": "#", "color": "red" },
            { "title": "Science News: Telescope Images", "url": "#", "color": "blue" },
            { "title": "Local City Hall News", "url": "#", "color": "black" },
            { "title": "Latest on Terrorism Threats", "url": "#", "color": "red" },
            { "title": "Sports: Player Transfer News", "url": "#", "color": "green" },
            { "title": "Entertainment: Music Chart Update", "url": "#", "color": "purple" },
            { "title": "Business: New Company Launched", "url": "#", "color": "blue" },
            { "title": "Commentary on Social Media", "url": "#", "color": "black" },
            { "title": "Urgent Political News", "url": "#", "color": "red" },
            { "title": "Global Aid Effort Underway", "url": "#", "color": "red" },
            { "title": "New Economic Report", "url": "#", "color": "blue" },
            { "title": "The Latest in Robotics", "url": "#", "color": "green" },
            { "title": "The Future of Education", "url": "#", "color": "black" },
            { "title": "Political Debate Heats Up", "url": "#", "color": "red" },
            { "title": "Health: New Vaccine Trial", "url": "#", "color": "blue" },
            { "title": "World Politics: New Trade Deal", "url": "#", "color": "green" },
            { "title": "Finance: Inflation Report", "url": "#", "color": "black" },
            { "title": "Entertainment: Viral Video", "url": "#", "color": "purple" },
            { "title": "Crisis in an Asian Nation", "url": "#", "color": "red" },
            { "title": "Science News: Asteroid Discovery", "url": "#", "color": "blue" },
            { "title": "Local School Board Meeting", "url": "#", "color": "black" },
            { "title": "Latest on Global Tensions", "url": "#", "color": "red" },
            { "title": "Sports: Final Scores", "url": "#", "color": "green" },
            { "title": "Entertainment: Reality TV Update", "url": "#", "color": "purple" },
            { "title": "Business: Major Layoffs Announced", "url": "#", "color": "blue" },
            { "title": "Commentary on Public Policy", "url": "#", "color": "black" },
            { "title": "Urgent National Security News", "url": "#", "color": "red" },
            { "title": "Disaster Relief Efforts Begin", "url": "#", "color": "red" },
            { "title": "New Global Market Trends", "url": "#", "color": "blue" },
            { "title": "The Latest in Renewable Energy", "url": "#", "color": "green" },
            { "title": "The Future of AI", "url": "#", "color": "black" }
        ];

        /**
         * Initializes Firebase and authenticates the user.
         */
        async function initializeFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // Authenticate the user securely
                if (authToken) {
                    await signInWithCustomToken(auth, authToken);
                } else {
                    await signInAnonymously(auth);
                }
                
                userId = auth.currentUser?.uid || crypto.randomUUID();
                
                setupRealtimeListener();
            } catch (error) {
                console.error("Firebase initialization or authentication failed:", error);
                document.getElementById('statusMessage').textContent = 'Error: Failed to connect to backend.';
            }
        }

        /**
         * Sets up a real-time listener to fetch and display link data.
         * The data is stored in a single Firestore document, simulating a flat-file system.
         */
        function setupRealtimeListener() {
            if (!db || !userId) {
                console.error('Firestore or user ID not available.');
                return;
            }

            const docRef = doc(db, 'artifacts', appId, 'users', userId, 'links', 'data');
            const unsubscribe = onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists() && docSnap.data().content) {
                    try {
                        allLinksData = JSON.parse(docSnap.data().content);
                        allLinksData.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)); // Sort chronologically (newest first)
                        renderLinks(allLinksData.slice(0, LINKS_TO_DISPLAY)); // Render only the latest links
                        document.getElementById('editorContent').value = JSON.stringify(allLinksData, null, 2);
                        document.getElementById('statusMessage').textContent = 'Links updated in real-time.';
                        document.getElementById('viewArchiveBtn').classList.remove('hidden');
                        document.getElementById('viewArchiveBtn').textContent = 'View Full Archive';
                    } catch (e) {
                        console.error("Error parsing link data:", e);
                        document.getElementById('statusMessage').textContent = 'Error: Invalid data format.';
                    }
                } else {
                    console.log("No link data found. Initializing with placeholder content.");
                    allLinksData = placeholderLinks;
                    renderLinks(allLinksData);
                    document.getElementById('editorContent').value = JSON.stringify(allLinksData, null, 2);
                    document.getElementById('statusMessage').textContent = 'Ready to add your links.';
                    document.getElementById('viewArchiveBtn').classList.add('hidden');
                }
            }, (error) => {
                console.error("Firestore listen failed:", error);
                document.getElementById('statusMessage').textContent = 'Error: Lost connection to backend.';
            });
            // You can optionally return unsubscribe to stop listening later
        }

        /**
         * Toggles between showing the recent links and all links.
         */
        function toggleArchiveView() {
            const archiveBtn = document.getElementById('viewArchiveBtn');
            if (archiveBtn.textContent === 'View Full Archive') {
                renderLinks(allLinksData);
                archiveBtn.textContent = 'View Recent Links';
            } else {
                renderLinks(allLinksData.slice(0, LINKS_TO_DISPLAY));
                archiveBtn.textContent = 'View Full Archive';
            }
        }

        /**
         * Renders the links from the data array into the correct columns.
         * @param {Array<Object>} links - An array of link objects.
         */
        function renderLinks(links) {
            const columns = document.querySelectorAll('.link-column');
            columns.forEach(col => col.innerHTML = ''); // Clear all columns

            links.forEach((link, index) => {
                const colIndex = index % columns.length;
                const linkElement = document.createElement('a');
                linkElement.href = link.url;
                linkElement.target = "_blank"; // Open in new tab
                linkElement.textContent = link.title;
                linkElement.classList.add('block', 'link-text', 'hover:underline');
                if (link.color) {
                    linkElement.classList.add(`color-${link.color}`);
                } else {
                    linkElement.classList.add('color-black'); // Default to black if no color
                }
                columns[colIndex].appendChild(linkElement);
            });
        }

        /**
         * Saves the content from the editor to Firestore.
         */
        async function saveContent() {
            document.getElementById('statusMessage').textContent = 'Saving...';
            const editorContent = document.getElementById('editorContent').value;
            const docRef = doc(db, 'artifacts', appId, 'users', userId, 'links', 'data');

            // Sanitize and validate the data before saving
            let parsedContent = [];
            try {
                parsedContent = JSON.parse(editorContent);
                // Basic validation to ensure it's an array of objects
                if (!Array.isArray(parsedContent) || !parsedContent.every(item => typeof item === 'object' && item !== null)) {
                    throw new Error("Invalid data format. Expected an array of objects.");
                }

                // Add a timestamp to any new links that don't have one
                const now = new Date().toISOString();
                parsedContent.forEach(link => {
                    if (!link.timestamp) {
                        link.timestamp = now;
                    }
                });
            } catch (e) {
                document.getElementById('statusMessage').textContent = `Error: Invalid JSON format. Please check your data.`;
                console.error(e);
                return;
            }

            try {
                await setDoc(docRef, {
                    content: JSON.stringify(parsedContent),
                    updatedAt: new Date().toISOString()
                }, { merge: true });
                // The onSnapshot listener will handle the UI update
            } catch (error) {
                console.error("Error saving document:", error);
                document.getElementById('statusMessage').textContent = 'Error: Failed to save changes.';
            }
        }

        /**
         * Toggles the visibility of the editor panel.
         */
        function toggleEditor() {
            const editorPanel = document.getElementById('editorPanel');
            editorPanel.classList.toggle('hidden');
        }

        // Initialize the app directly instead of waiting for the 'load' event
        initializeFirebase();

        // Expose functions to the global scope for button clicks
        window.saveContent = saveContent;
        window.toggleEditor = toggleEditor;
        window.toggleArchiveView = toggleArchiveView;
    </script>

    <!-- Header Section -->
    <header class="w-full max-w-7xl mb-8">
        <div class="text-center">
            <h1 id="thedayluge-title" class="text-4xl font-bold text-gray-800 uppercase mb-2" onclick="toggleEditor()">THE DAY LUGE</h1>
        </div>
    </header>

    <!-- Main Content - Multi-column Link Section -->
    <main class="w-full max-w-7xl">
        <div class="grid grid-cols-4 gap-6">
            <!-- Column 1 -->
            <div class="link-column space-y-2"></div>
            <!-- Column 2 -->
            <div class="link-column space-y-2"></div>
            <!-- Column 3 -->
            <div class="link-column space-y-2"></div>
            <!-- Column 4 -->
            <div class="link-column space-y-2"></div>
        </div>
        <div class="flex justify-center mt-6">
            <button id="viewArchiveBtn" onclick="toggleArchiveView()" class="hidden px-4 py-2 bg-gray-200 text-gray-800 rounded-lg shadow-md hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400">
                View Full Archive
            </button>
        </div>
    </main>

    <!-- Admin Panel (Hidden by default) -->
    <div id="editorPanel" class="hidden w-full max-w-4xl bg-gray-100 shadow-xl rounded-lg p-6 mb-8 border border-gray-300">
        <h2 class="text-2xl font-semibold text-gray-700 mb-4">Link Editor</h2>
        <p class="text-sm text-gray-500 mb-4">
            Enter your links as a JSON array. Each object should have a `title`, `url`, and an optional `color`. A `timestamp` will be added automatically if one is not provided. New links appear at the top.
            <br/>
            Example: <br/> `[{"title": "Breaking News", "url": "https://example.com/news", "color": "red"}]`
        </p>
        <textarea id="editorContent" class="w-full h-64 p-4 border rounded-md resize-none font-mono text-sm bg-white" placeholder='[{"title": "Welcome to The Day Luge!", "url": "#", "color": "blue"}, {"title": "Another placeholder link...", "url": "#", "color": "black"}, {"title": "This site is a work in progress.", "url": "#", "color": "gray"}]'></textarea>
        <div class="mt-4 flex justify-end items-center">
            <span id="statusMessage" class="mr-4 text-sm text-gray-600"></span>
            <button onclick="saveContent()" class="px-6 py-2 bg-blue-600 text-white rounded-md shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors">
                Save Links
            </button>
        </div>
    </div>

    <!-- Footer Section -->
    <footer class="w-full max-w-7xl p-4 text-center text-sm mt-8">
        <p class="text-gray-500">&copy; 2023 The Day Luge. All Rights Reserved.</p>
    </footer>

</body>
</html>
